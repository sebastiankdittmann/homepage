name: Pull Request Tests

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --coverage --json --outputFile=test-results.json --testLocationInResults --coverageReporters=json-summary --coverageReporters=text

      - name: Generate test summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read test results
            let testResults = { success: false };
            let testSummary = '### âŒ Test Results\n\nTests failed to run or results file not found.';
            
            try {
              if (fs.existsSync('test-results.json')) {
                const rawResults = fs.readFileSync('test-results.json', 'utf8');
                testResults = JSON.parse(rawResults);
                
                const { numTotalTests, numPassedTests, numFailedTests, numPendingTests, success } = testResults;
                
                const icon = success ? 'âœ…' : 'âŒ';
                testSummary = `### ${icon} Test Results\n\n`;
                testSummary += '| Metric | Count |\n';
                testSummary += '|--------|-------|\n';
                testSummary += `| Total Tests | ${numTotalTests} |\n`;
                testSummary += `| Passed | ${numPassedTests} |\n`;
                testSummary += `| Failed | ${numFailedTests} |\n`;
                testSummary += `| Pending | ${numPendingTests} |\n`;
                testSummary += `| Status | ${success ? 'âœ… All tests passed' : 'âŒ Some tests failed'} |\n`;
              }
            } catch (error) {
              console.error('Error reading test results:', error);
            }
            
            // Read coverage summary
            let coverageSummary = '\n### ðŸ“Š Code Coverage\n\n';
            try {
              if (fs.existsSync('coverage/coverage-summary.json')) {
                const rawCoverage = fs.readFileSync('coverage/coverage-summary.json', 'utf8');
                const coverage = JSON.parse(rawCoverage);
                const { total } = coverage;
                
                coverageSummary += '| Metric | Coverage |\n';
                coverageSummary += '|--------|----------|\n';
                coverageSummary += `| Lines | ${total.lines.pct}% (${total.lines.covered}/${total.lines.total}) |\n`;
                coverageSummary += `| Statements | ${total.statements.pct}% (${total.statements.covered}/${total.statements.total}) |\n`;
                coverageSummary += `| Functions | ${total.functions.pct}% (${total.functions.covered}/${total.functions.total}) |\n`;
                coverageSummary += `| Branches | ${total.branches.pct}% (${total.branches.covered}/${total.branches.total}) |\n`;
              }
            } catch (error) {
              console.error('Error reading coverage summary:', error);
              coverageSummary += '\nâŒ Coverage data not available\n';
            }
            
            const comment = testSummary + coverageSummary;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Test Results')
            );
            
            // Create or update comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Fail if tests failed
        if: always()
        run: |
          if [ -f test-results.json ]; then
            if ! grep -q '"success":true' test-results.json; then
              echo "Tests failed!"
              exit 1
            fi
          else
            echo "Test results file not found!"
            exit 1
          fi
